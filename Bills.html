<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGen QuickBills</title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              teal: { 500: '#00c7a4', 600: '#00b090' },
              indigo: { 500: '#6366f1', 600: '#4f46e5' },
              slate: { 800: '#1e293b', 900: '#0f172a' },
              dark: '#2d2d38'
            },
            fontFamily: { sans: ['Inter', 'sans-serif'] }
          }
        }
      }
    </script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        
        .hidden { display: none !important; }

        /* Print Logic */
        @media print {
            @page { margin: 0; size: auto; }
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
                overflow: visible !important;
                background: white !important;
            }
            #app, #loading-screen { display: none !important; }
            #pdf-template-container, #agreement-template-container {
                display: block !important;
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            #pdf-template, #agreement-template {
                width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                color: black !important;
            }
        }
    </style>
</head>
<body class="text-dark antialiased overflow-x-hidden">

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-white transition-opacity duration-500">
        <div class="text-center animate-pulse">
            <div class="w-24 h-24 mx-auto mb-4 bg-teal-500 rounded-2xl flex items-center justify-center shadow-lg transform rotate-3">
                <i class="fas fa-bolt text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-dark tracking-tight">
                NextGen <span class="text-teal-500">QuickBills</span>
            </h1>
            <p class="text-gray-400 mt-2 text-sm font-medium">Professional Solutions</p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="hidden min-h-screen flex flex-col relative">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="flex-col h-full absolute inset-0 bg-slate-50 overflow-y-auto">
            <header class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 px-6 py-4 shadow-sm">
                <div class="flex justify-between items-center max-w-5xl mx-auto mb-4">
                    <div>
                        <h1 id="dashboard-title" class="text-xl font-bold text-dark">Dashboard</h1>
                        <p class="text-xs text-gray-500">NextGen</p>
                    </div>
                    
                    <button id="btn-create-new" onclick="router.handleCreate()" class="text-white p-3 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center w-12 h-12">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex p-1 bg-gray-100 rounded-xl max-w-5xl mx-auto space-x-1">
                    <button onclick="dashboard.switchTab('INVOICE')" id="tab-invoice" class="flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all">Invoices</button>
                    <button onclick="dashboard.switchTab('QUOTATION')" id="tab-quotation" class="flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all">Quotations</button>
                    <button onclick="dashboard.switchTab('AGREEMENT')" id="tab-agreement" class="flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all">Agreements</button>
                </div>
            </header>

            <div class="px-6 py-4 max-w-5xl mx-auto w-full">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Search..." 
                        class="w-full pl-11 pr-4 py-3 bg-white rounded-xl border-none shadow-sm focus:ring-2 focus:ring-teal-500 text-gray-700 outline-none">
                </div>
            </div>

            <div id="bills-list" class="flex-1 px-6 pb-20 max-w-5xl mx-auto w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Bills will be injected here -->
            </div>
            
            <div id="dashboard-loading" class="hidden flex flex-col items-center justify-center py-20 text-gray-400">
                <i class="fas fa-spinner fa-spin text-3xl mb-4 text-teal-500"></i>
                <p>Loading records...</p>
            </div>
            
             <div id="dashboard-empty" class="hidden text-center py-20 text-gray-400 w-full col-span-full">
                <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                <p id="dashboard-empty-text">No records found.</p>
            </div>
        </div>

        <!-- VIEW: CREATE BILL (Invoice/Quote) -->
        <div id="view-create" class="hidden flex-col h-full absolute inset-0 bg-slate-50 overflow-y-auto">
            <div class="bg-white sticky top-0 z-10 px-6 py-4 border-b border-gray-200 flex justify-between items-center shadow-sm">
                <button onclick="router.navigate('dashboard')" class="text-gray-500 hover:text-dark">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 id="create-title" class="text-lg font-bold text-dark">New Entry</h2>
                <div class="w-6"></div>
            </div>

            <form id="create-form" class="flex-1 p-6 max-w-3xl mx-auto w-full pb-32">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4">Customer Details</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="input-date" required class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
                            <input type="text" id="input-name" required placeholder="John Doe" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-gray-400 font-normal text-xs">(Optional)</span></label>
                            <input type="tel" id="input-phone" placeholder="9876543210" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address <span class="text-gray-400 font-normal text-xs">(Optional)</span></label>
                            <input type="text" id="input-address" placeholder="City, Street" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 transition-colors">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold">Items</h3>
                        <button type="button" id="btn-add-item" onclick="formHandler.addItem()" class="text-sm font-bold hover:opacity-80">+ Add Item</button>
                    </div>
                    <div id="items-container" class="space-y-3">
                        <!-- Items injected here -->
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="font-bold text-gray-600">Total Amount</span>
                        <span id="create-total" class="text-2xl font-bold">₹0.00</span>
                    </div>
                </div>
                
                <div class="fixed bottom-6 left-0 right-0 px-6 max-w-3xl mx-auto z-20">
                    <button type="submit" id="btn-save" class="w-full py-4 rounded-xl shadow-lg text-white font-bold text-lg transition-all transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>

        <!-- VIEW: CREATE AGREEMENT -->
        <div id="view-create-agreement" class="hidden flex-col h-full absolute inset-0 bg-slate-50 overflow-y-auto">
            <div class="bg-white sticky top-0 z-10 px-6 py-4 border-b border-gray-200 flex justify-between items-center shadow-sm">
                <button onclick="router.navigate('dashboard')" class="text-gray-500 hover:text-dark">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-lg font-bold text-dark">New Agreement</h2>
                <div class="w-6"></div>
            </div>

            <form id="create-agreement-form" class="flex-1 p-6 max-w-3xl mx-auto w-full pb-32">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4">Agreement Details</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Agreement Date</label>
                            <input type="date" id="agmt-input-date" required class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-slate-500 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Payment Day</label>
                            <input type="number" min="1" max="31" id="agmt-input-payday" placeholder="e.g. 5 (for 5th of every month)" required class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-slate-500 transition-colors">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                            <input type="text" id="agmt-input-name" required placeholder="Business Name / Client Name" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-slate-500 transition-colors">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Address</label>
                            <input type="text" id="agmt-input-address" placeholder="City, State" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-slate-500 transition-colors">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4">Subscription Plan</h3>
                    
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="plan" value="BASIC" class="w-5 h-5 text-slate-600 focus:ring-slate-500" checked>
                            <div class="ml-4">
                                <span class="block text-sm font-bold text-gray-900">Basic Plan</span>
                                <span class="block text-sm text-gray-500">Setup & Basic Features - ₹1000</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="plan" value="STANDARD" class="w-5 h-5 text-slate-600 focus:ring-slate-500">
                            <div class="ml-4">
                                <span class="block text-sm font-bold text-gray-900">Standard Plan</span>
                                <span class="block text-sm text-gray-500">Monthly Subscription - ₹1000 / month</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="plan" value="ULTRA" class="w-5 h-5 text-slate-600 focus:ring-slate-500">
                            <div class="ml-4">
                                <span class="block text-sm font-bold text-gray-900">Ultra Plan</span>
                                <span class="block text-sm text-gray-500">Premium Subscription - ₹1249 / month</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="fixed bottom-6 left-0 right-0 px-6 max-w-3xl mx-auto z-20">
                    <button type="submit" class="w-full py-4 rounded-xl shadow-lg text-white font-bold text-lg bg-slate-800 hover:bg-slate-900 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-file-contract"></i> Generate Agreement
                    </button>
                </div>
            </form>
        </div>

        <!-- VIEW: DETAIL (Common) -->
        <div id="view-detail" class="hidden flex-col h-full absolute inset-0 bg-white overflow-hidden z-20">
            <!-- Header -->
            <div class="bg-white px-6 py-4 border-b border-gray-100 flex items-center gap-4 z-20 shadow-sm">
                <button onclick="router.navigate('dashboard')" class="text-gray-500 hover:text-dark w-8 h-8 flex items-center justify-center -ml-2 rounded-full active:bg-gray-100">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex-1">
                    <h1 class="text-lg font-bold text-dark">Details</h1>
                </div>
                <div id="detail-type-badge" class="text-xs font-bold px-3 py-1.5 rounded-full"></div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto pb-32">
                <!-- Customer Card -->
                <div class="p-6 bg-slate-50 border-b border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 id="detail-name" class="text-2xl font-bold text-dark leading-tight break-words">Customer Name</h2>
                            <p id="detail-id" class="text-xs font-mono text-gray-400 mt-1 bg-white px-2 py-0.5 rounded border border-gray-200 inline-block">#000</p>
                        </div>
                        <div class="text-right shrink-0 ml-4">
                             <div class="inline-flex flex-col items-end">
                                <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Date</span>
                                <span id="detail-date" class="text-sm font-medium text-dark">01/01/2025</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 text-sm text-gray-600">
                        <div id="detail-phone-container" class="flex items-center gap-3">
                            <div id="detail-phone-icon" class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0">
                                <i class="fas fa-phone-alt text-xs"></i>
                            </div>
                            <span id="detail-phone" class="font-medium"></span>
                        </div>
                        <div id="detail-address-container" class="flex items-center gap-3">
                             <div id="detail-address-icon" class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0">
                                <i class="fas fa-map-marker-alt text-xs"></i>
                            </div>
                            <span id="detail-address" class="font-medium"></span>
                        </div>
                        
                        <!-- Extra fields for Agreement -->
                         <div id="detail-plan-container" class="hidden flex-col gap-1 mt-4 p-4 bg-white rounded-lg border border-gray-200">
                            <span class="text-xs font-bold uppercase text-gray-400">Selected Plan</span>
                            <span id="detail-plan-name" class="font-bold text-slate-800"></span>
                            <span id="detail-plan-price" class="text-sm text-slate-500"></span>
                            <span id="detail-payday-display" class="text-xs text-slate-400 mt-1"></span>
                        </div>
                    </div>
                </div>

                <!-- Items List (Only for Invoice/Quote) -->
                <div id="detail-items-wrapper" class="p-6">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Purchased Items</h3>
                    </div>
                    <div id="detail-items" class="space-y-0 divide-y divide-gray-50 border-t border-gray-50">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>

            <!-- Sticky Footer Actions -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                <div id="detail-total-row" class="flex justify-between items-center mb-4 px-2">
                    <span class="text-gray-500 font-medium text-sm">Grand Total</span>
                    <span id="detail-total" class="text-3xl font-bold">₹0.00</span>
                </div>
                
                <div id="detail-actions-grid" class="grid grid-cols-3 gap-3">
                    <button id="btn-print" onclick="outputHandler.print()" class="bg-gray-800 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-print text-sm"></i>
                        <span class="text-[10px]">Print</span>
                    </button>
                    <button id="btn-download-pdf" onclick="outputHandler.download()" class="bg-teal-500 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-file-download text-sm"></i>
                        <span class="text-[10px]">Save PDF</span>
                    </button>
                    <button id="btn-share-pdf" onclick="outputHandler.share()" class="bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-share-alt text-sm"></i>
                        <span class="text-[10px]">Share PDF</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- HIDDEN INVOICE PDF TEMPLATE -->
    <div id="pdf-template-container" class="hidden">
        <div id="pdf-template" style="width: 794px; min-height: 1123px; background-color: white; padding: 40px; font-family: 'Inter', sans-serif; color: #2d2d38; position: relative; box-sizing: border-box; margin: 0 auto;">
             <!-- PDF Header -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid; padding-bottom: 20px;" id="pdf-header-border">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- Custom Logo Image -->
                    <img src="Logo2.png" alt="Company Logo" crossOrigin="anonymous" style="width: 180px; height: auto; margin: 0;">
                </div>
                <div style="text-align: right;">
                    <div id="pdf-doc-label" style="font-size: 36px; font-weight: 900; color: #e2e8f0; text-transform: uppercase; line-height: 1;">INVOICE</div>
                    <div id="pdf-bill-id" style="margin-top: 10px; font-size: 14px; font-weight: bold; color: #475569;">#000000</div>
                    <div id="pdf-bill-date" style="font-size: 14px; color: #64748b;">01/01/2025</div>
                </div>
            </div>

            <!-- Info Columns -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                <div style="width: 45%;">
                    <h3 style="font-size: 12px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px;">From</h3>
                    <p style="margin: 0; font-weight: bold; font-size: 14px;">NextGen</p>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b; line-height: 1.5;">
                        Ahmedabad, Gujarat<br>
                        India<br>
                        +91 9173213576
                    </p>
                </div>
                <div style="width: 45%;">
                    <h3 id="pdf-to-label" style="font-size: 12px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px;">Bill To</h3>
                    <p id="pdf-customer-name" style="margin: 0; font-weight: bold; font-size: 16px; color: #0f172a;">Customer Name</p>
                    
                    <!-- Optional Fields -->
                    <p id="pdf-customer-phone" style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">9999999999</p>
                    <p id="pdf-customer-address" style="margin: 2px 0 0 0; font-size: 13px; color: #64748b;">Address Line</p>
                </div>
            </div>

            <!-- Table -->
            <div style="margin-bottom: 40px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr id="pdf-table-header" style="border-bottom: 2px solid #e2e8f0; color: #475569;">
                            <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase; width: 50px;">#</th>
                            <th style="padding: 12px 15px; text-align: left; font-size: 12px; text-transform: uppercase;">Item Description</th>
                            <th style="padding: 12px 15px; text-align: right; font-size: 12px; text-transform: uppercase; width: 120px;">Price (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-items-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Totals -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 60px;">
                <div style="width: 250px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="font-size: 14px; color: #64748b;">Subtotal</span>
                        <span id="pdf-subtotal" style="font-size: 14px; font-weight: bold;">₹0.00</span>
                    </div>
                    <div id="pdf-total-container" style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 2px solid;">
                        <span id="pdf-total-label" style="font-size: 18px; font-weight: bold;">Total</span>
                        <span id="pdf-total" style="font-size: 24px; font-weight: bold;">₹0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="margin-top: auto; padding-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
                    <div style="font-size: 10px; color: #94a3b8; max-width: 300px;">
                        <strong style="display: block; margin-bottom: 5px; text-transform: uppercase;">Terms & Conditions</strong>
                        <span id="pdf-terms">Payment is due upon receipt.</span>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 150px; border-bottom: 1px solid #cbd5e1; margin-bottom: 5px;"></div>
                        <div style="font-size: 10px; font-weight: bold; text-transform: uppercase; color: #64748b;">Authorized Signatory</div>
                    </div>
                </div>
                <div style="border-top: 1px solid #f1f5f9; paddingTop: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span id="pdf-footer-brand" style="font-size: 10px; font-weight: bold;">NextGen</span>
                    <span style="font-size: 10px; color: #cbd5e1;">Generated by NextGen QuickBills</span>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN AGREEMENT PDF TEMPLATE -->
    <div id="agreement-template-container" class="hidden">
        <div id="agreement-template" style="width: 794px; min-height: 1123px; background-color: white; padding: 40px 50px; font-family: 'Inter', sans-serif; color: #1e293b; position: relative; box-sizing: border-box; margin: 0 auto;">
            
            <!-- Agreement Header (Redesigned to Match Invoice) -->
             <div style="display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 2px solid #6366f1; padding-bottom: 15px;">
                <div style="display: flex; align-items: center;">
                    <!-- Logo Left Aligned -->
                    <img src="Logo2.png" alt="Company Logo" crossOrigin="anonymous" style="width: 180px; height: auto; margin: 0;">
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 28px; font-weight: 900; color: #1e293b; text-transform: uppercase; letter-spacing: 1px; line-height: 1;">SAAS AGREEMENT</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Service Agreement</div>
                </div>
            </div>

            <div style="margin-bottom: 20px; font-size: 11px; line-height: 1.5; display: flex; justify-content: space-between;">
                <div style="width: 48%;">
                    <p style="margin-bottom: 2px;"><strong>Service Provider:</strong> NextGen</p>
                    <p style="color: #64748b;">Ahmedabad, Gujarat</p>
                </div>
                <div style="width: 48%; text-align: right;">
                    <p style="margin-bottom: 2px;"><strong>Date:</strong> <span id="agmt-date"></span></p>
                    <p><strong>Client:</strong> <span id="agmt-client" style="font-weight: bold;"></span></p>
                    <p style="color: #64748b;"><span id="agmt-address"></span></p>
                </div>
            </div>

            <!-- Body -->
            <div style="font-size: 10px; line-height: 1.45; color: #334155; text-align: justify;">
                
                <h3 style="font-size: 11px; font-weight: 700; color: #0f172a; margin-top: 10px; margin-bottom: 4px; text-transform: uppercase;">1. Service Description</h3>
                
                <!-- Dynamic Service Description Injected Here -->
                <p id="agmt-service-desc" style="margin-bottom: 8px;">
                    <!-- JS will populate this -->
                </p>

                <h3 style="font-size: 11px; font-weight: 700; color: #0f172a; margin-top: 10px; margin-bottom: 4px; text-transform: uppercase;">2. Subscription & Payment</h3>
                <p style="margin-bottom: 4px;">
                    The Client agrees to pay the subscription fees as per the selected plan. All payments shall be made in advance as per the agreed billing cycle (monthly/quarterly/annual).
                </p>
                
                <!-- Plan Details (No Highlight) -->
                <div style="margin-bottom: 8px; margin-top: 8px;">
                     <p style="margin: 0;"><strong>Selected Plan:</strong> <span id="agmt-plan-name"></span></p>
                     <p style="margin: 0;"><strong>Price:</strong> <span id="agmt-plan-price"></span></p>
                </div>

                <p style="margin-bottom: 4px;">
                    <strong>Payment Terms:</strong> <span id="agmt-paydate"></span>
                </p>

                <h3 style="font-size: 11px; font-weight: 700; color: #0f172a; margin-top: 10px; margin-bottom: 4px; text-transform: uppercase;">3. Terms and Conditions</h3>
                
                <p style="margin-bottom: 6px;">
                    <strong>Software Service:</strong> The Client agrees to a minimum subscription period of six (6) months from the date of activation. During this period, cancellation or termination by the Client is not permitted, and all subscription fees for the six-month term shall remain payable in full. If the Client cancels or discontinues the service before completing six months, the remaining amount shall be payable in full immediately.
                </p>
                
                <p style="margin-bottom: 6px;">
                    <strong>Termination:</strong> After completion of the six-month minimum period, either party may terminate the subscription with 30 days’ written notice.
                </p>
                
                <p style="margin-bottom: 6px;">
                    <strong>Support and Service:</strong> General service and support shall be available only on working days through call or online communication. No specific time slots are guaranteed, but the Provider will respond and assist as soon as reasonably possible. Menu updates, item additions, price modifications, or any other configuration changes requested by the Client are considered part of the ongoing service provided by the Provider. The Client acknowledges that such service requests shall require a minimum processing time of seventy-two (72) hours from the time of request or confirmation.
                </p>
                
                <p style="margin-top: 10px; font-style: italic; color: #64748b;">
                    By signing below or by using the Restaurant Management System, the Client confirms that they have read, understood, and agreed to these Terms and Conditions.
                </p>
            </div>

            <!-- Signatures -->
            <div style="display: flex; justify-content: space-between; margin-top: 40px; padding-top: 10px;">
                <div style="width: 45%; text-align: left;">
                    <p style="font-size: 11px; font-weight: bold; margin-bottom: 25px;">Service Provider: NextGen</p>
                    <div style="border-bottom: 1px solid #94a3b8; width: 100%; margin-bottom: 4px;"></div>
                    <p style="font-size: 9px; color: #64748b;">Signature</p>
                    <p style="font-size: 9px; color: #64748b; margin-top: 5px;">Date: _________________</p>
                </div>
                <div style="width: 45%; text-align: left;">
                    <p style="font-size: 11px; font-weight: bold; margin-bottom: 25px;">Client: <span id="agmt-sign-client"></span></p>
                    <div style="border-bottom: 1px solid #94a3b8; width: 100%; margin-bottom: 4px;"></div>
                    <p style="font-size: 9px; color: #64748b;">Signature</p>
                    <p style="font-size: 9px; color: #64748b; margin-top: 5px;">Date: _________________</p>
                </div>
            </div>
            
            <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; border-top: 1px solid #f1f5f9; padding-top: 8px;">
                <span style="font-size: 8px; color: #cbd5e1;">Generated by NextGen QuickBills</span>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwU92x1SYftWOrjYaLm_nEeI1sIYHo1p1Ypzi0hV8IHSkknuJ86tpSGqijm9J43o4VF/exec';
        const QUOTATION_STORAGE_KEY = 'nextgen_quickbills_quotations';
        const AGREEMENT_STORAGE_KEY = 'nextgen_quickbills_agreements';

        // --- State ---
        const state = {
            bills: [],      
            quotations: [], 
            agreements: [],
            activeTab: 'INVOICE', 
            currentBill: null,
            cartItems: [{ name: '', price: 0 }]
        };

        // --- DOM Elements ---
        const views = {
            loading: document.getElementById('loading-screen'),
            app: document.getElementById('app'),
            dashboard: document.getElementById('view-dashboard'),
            create: document.getElementById('view-create'),
            createAgreement: document.getElementById('view-create-agreement'),
            detail: document.getElementById('view-detail')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                views.loading.style.opacity = '0';
                setTimeout(() => {
                    views.loading.style.display = 'none';
                    views.app.classList.remove('hidden');
                    router.navigate('dashboard');
                }, 500);
            }, 2500);

            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('agmt-input-date').valueAsDate = new Date();

            document.getElementById('search-input').addEventListener('input', (e) => dashboard.filter(e.target.value));
            document.getElementById('create-form').addEventListener('submit', formHandler.submit);
            document.getElementById('create-agreement-form').addEventListener('submit', formHandler.submitAgreement);
            
            api.fetchBills(); 
            storage.fetchQuotations(); 
            storage.fetchAgreements();
        });

        // --- Router ---
        const router = {
            navigate: (viewName) => {
                views.dashboard.classList.add('hidden');
                views.create.classList.add('hidden');
                views.createAgreement.classList.add('hidden');
                views.detail.classList.add('hidden');

                if (viewName === 'dashboard') {
                    views.dashboard.classList.remove('hidden');
                    dashboard.render();
                } else if (viewName === 'create') {
                    views.create.classList.remove('hidden');
                    formHandler.reset();
                    formHandler.applyTheme(); 
                } else if (viewName === 'createAgreement') {
                    views.createAgreement.classList.remove('hidden');
                    document.getElementById('create-agreement-form').reset();
                    document.getElementById('agmt-input-date').valueAsDate = new Date();
                } else if (viewName === 'detail') {
                    views.detail.classList.remove('hidden');
                }
            },
            
            handleCreate: () => {
                if (state.activeTab === 'AGREEMENT') {
                    router.navigate('createAgreement');
                } else {
                    router.navigate('create');
                }
            }
        };

        // --- Storage Service ---
        const storage = {
            fetchQuotations: () => {
                try {
                    const data = localStorage.getItem(QUOTATION_STORAGE_KEY);
                    state.quotations = data ? JSON.parse(data) : [];
                    state.quotations = state.quotations.map(q => ({...q, type: 'QUOTATION'}));
                } catch (e) {
                    console.error(e);
                    state.quotations = [];
                }
            },
            saveQuotation: (quotation) => {
                state.quotations.unshift(quotation);
                localStorage.setItem(QUOTATION_STORAGE_KEY, JSON.stringify(state.quotations));
            },
            fetchAgreements: () => {
                try {
                    const data = localStorage.getItem(AGREEMENT_STORAGE_KEY);
                    state.agreements = data ? JSON.parse(data) : [];
                    state.agreements = state.agreements.map(a => ({...a, type: 'AGREEMENT'}));
                } catch (e) {
                    console.error(e);
                    state.agreements = [];
                }
            },
            saveAgreement: (agreement) => {
                state.agreements.unshift(agreement);
                localStorage.setItem(AGREEMENT_STORAGE_KEY, JSON.stringify(state.agreements));
            }
        };

        // --- API Service ---
        const api = {
            fetchBills: async () => {
                const loader = document.getElementById('dashboard-loading');
                loader.classList.remove('hidden');
                try {
                    const response = await fetch(API_URL);
                    const result = await response.json();
                    if (result.status === 'success') {
                        state.bills = result.data.reverse().map(b => ({...b, type: 'INVOICE'}));
                        dashboard.render();
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                } finally {
                    loader.classList.add('hidden');
                }
            },

            saveBill: async (billData) => {
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'saveBill', ...billData })
                    });
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    return false;
                }
            }
        };

        // --- Dashboard Logic ---
        const dashboard = {
            switchTab: (tab) => {
                state.activeTab = tab;
                const btnInvoice = document.getElementById('tab-invoice');
                const btnQuote = document.getElementById('tab-quotation');
                const btnAgmt = document.getElementById('tab-agreement');
                const btnCreate = document.getElementById('btn-create-new');
                
                // Reset styles
                const inactiveStyle = 'flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all text-gray-400 hover:text-gray-600';
                btnInvoice.className = inactiveStyle;
                btnQuote.className = inactiveStyle;
                btnAgmt.className = inactiveStyle;

                if (tab === 'INVOICE') {
                    btnInvoice.className = 'flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all bg-white text-teal-600 shadow-sm';
                    btnCreate.className = 'bg-teal-500 hover:bg-teal-600 text-white p-3 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center w-12 h-12';
                    document.getElementById('dashboard-title').innerText = 'Dashboard';
                } else if (tab === 'QUOTATION') {
                    btnQuote.className = 'flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all bg-white text-indigo-600 shadow-sm';
                    btnCreate.className = 'bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center w-12 h-12';
                    document.getElementById('dashboard-title').innerText = 'Quotations';
                } else {
                    btnAgmt.className = 'flex-1 py-2 text-xs md:text-sm font-bold rounded-lg transition-all bg-white text-slate-800 shadow-sm';
                    btnCreate.className = 'bg-slate-700 hover:bg-slate-800 text-white p-3 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center w-12 h-12';
                    document.getElementById('dashboard-title').innerText = 'Agreements';
                }
                
                dashboard.render();
            },

            render: (filteredData = null) => {
                let data = [];
                if (filteredData) {
                    data = filteredData;
                } else {
                    if (state.activeTab === 'INVOICE') data = state.bills;
                    else if (state.activeTab === 'QUOTATION') data = state.quotations;
                    else data = state.agreements;
                }
                
                const container = document.getElementById('bills-list');
                const empty = document.getElementById('dashboard-empty');
                container.innerHTML = '';

                if (data.length === 0) {
                    empty.classList.remove('hidden');
                    let text = 'records';
                    if (state.activeTab === 'INVOICE') text = 'invoices';
                    if (state.activeTab === 'QUOTATION') text = 'quotations';
                    if (state.activeTab === 'AGREEMENT') text = 'agreements';
                    document.getElementById('dashboard-empty-text').innerText = `No ${text} found.`;
                    return;
                }
                empty.classList.add('hidden');

                let themeColor = 'teal';
                if (state.activeTab === 'QUOTATION') themeColor = 'indigo';
                if (state.activeTab === 'AGREEMENT') themeColor = 'slate';

                data.forEach(item => {
                    const dateStr = new Date(item.date).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = `bg-white p-5 rounded-2xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-${themeColor}-100 group animate-fade-in-up`;
                    card.onclick = () => detailHandler.show(item);
                    
                    if (state.activeTab === 'AGREEMENT') {
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-dark text-lg group-hover:text-slate-600 transition-colors">${item.customerName}</h3>
                                    <p class="text-xs text-gray-500 font-medium bg-gray-100 inline-block px-2 py-1 rounded-md mt-1">AGREEMENT</p>
                                </div>
                                <span class="text-xs font-semibold text-gray-400">${dateStr}</span>
                            </div>
                            <div class="flex justify-between items-end border-t border-gray-50 pt-3 mt-2">
                                <div class="text-xs text-gray-500">
                                    <p class="mt-1 font-bold text-slate-700">${item.planName}</p>
                                    <p>${item.planPrice}</p>
                                </div>
                                <span class="text-xs font-bold text-slate-300"><i class="fas fa-file-contract"></i></span>
                            </div>
                        `;
                    } else {
                        const total = parseFloat(item.total).toFixed(2);
                        const phoneDisplay = item.phone ? `<p><i class="fas fa-phone-alt mr-1 text-${themeColor}-500 opacity-60"></i> ${item.phone}</p>` : '';
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-dark text-lg group-hover:text-${themeColor}-600 transition-colors">${item.customerName}</h3>
                                    <p class="text-xs text-gray-500 font-medium bg-gray-100 inline-block px-2 py-1 rounded-md mt-1">${item.billId}</p>
                                </div>
                                <span class="text-xs font-semibold text-gray-400">${dateStr}</span>
                            </div>
                            <div class="flex justify-between items-end border-t border-gray-50 pt-3 mt-2">
                                <div class="text-xs text-gray-500">
                                    ${phoneDisplay}
                                    <p class="mt-1"><i class="fas fa-layer-group mr-1 text-${themeColor}-500 opacity-60"></i> ${item.items.length} items</p>
                                </div>
                                <span class="text-lg font-bold text-dark">₹${total}</span>
                            </div>
                        `;
                    }
                    container.appendChild(card);
                });
            },

            filter: (term) => {
                const lowerTerm = term.toLowerCase();
                let list = [];
                 if (state.activeTab === 'INVOICE') list = state.bills;
                else if (state.activeTab === 'QUOTATION') list = state.quotations;
                else list = state.agreements;

                const filtered = list.filter(item => {
                    const name = String(item.customerName || '').toLowerCase();
                    const date = String(item.date || '');
                    
                    if (item.type === 'AGREEMENT') {
                        return name.includes(lowerTerm) || date.includes(lowerTerm);
                    }
                    
                    const phone = String(item.phone || '');
                    const id = String(item.billId || '').toLowerCase();
                    return name.includes(lowerTerm) || phone.includes(lowerTerm) || date.includes(lowerTerm) || id.includes(lowerTerm);
                });
                dashboard.render(filtered);
            }
        };

        // --- Form Logic ---
        const formHandler = {
            reset: () => {
                state.cartItems = [{ name: '', price: 0 }];
                document.getElementById('input-name').value = '';
                document.getElementById('input-phone').value = '';
                document.getElementById('input-address').value = '';
                document.getElementById('input-date').valueAsDate = new Date();
                formHandler.renderItems();
            },

            applyTheme: () => {
                const isInvoice = state.activeTab === 'INVOICE';
                const color = isInvoice ? 'teal' : 'indigo';
                const title = isInvoice ? 'New Invoice' : 'New Quotation';
                document.getElementById('create-title').innerText = title;
                const btnSave = document.getElementById('btn-save');
                btnSave.className = `w-full py-4 rounded-xl shadow-lg text-white font-bold text-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 bg-${color}-500 hover:bg-${color}-600`;
                document.getElementById('btn-add-item').className = `text-${color}-500 text-sm font-bold hover:opacity-80`;
            },

            addItem: () => {
                state.cartItems.push({ name: '', price: 0 });
                formHandler.renderItems();
            },

            removeItem: (index) => {
                if (state.cartItems.length > 1) {
                    state.cartItems.splice(index, 1);
                    formHandler.renderItems();
                }
            },

            updateItem: (index, field, value) => {
                if (field === 'price') {
                    state.cartItems[index][field] = parseFloat(value) || 0;
                } else {
                    state.cartItems[index][field] = value;
                }
                formHandler.updateTotal();
            },

            renderItems: () => {
                const container = document.getElementById('items-container');
                container.innerHTML = '';
                const color = state.activeTab === 'INVOICE' ? 'teal' : 'indigo';

                state.cartItems.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex gap-2 items-start animate-fade-in-up';
                    div.innerHTML = `
                        <div class="flex-1">
                            <input type="text" placeholder="Item name" required value="${item.name}" 
                                oninput="formHandler.updateItem(${index}, 'name', this.value)"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-transparent focus:bg-white focus:border-${color}-500 outline-none text-sm">
                        </div>
                        <div class="w-24">
                            <input type="number" placeholder="0.00" min="0" step="0.01" required value="${item.price || ''}" 
                                oninput="formHandler.updateItem(${index}, 'price', this.value)"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-transparent focus:bg-white focus:border-${color}-500 outline-none text-sm text-right">
                        </div>
                        ${state.cartItems.length > 1 ? `
                        <button type="button" onclick="formHandler.removeItem(${index})" class="p-3 text-red-400 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>` : ''}
                    `;
                    container.appendChild(div);
                });
                formHandler.updateTotal();
            },

            updateTotal: () => {
                const total = state.cartItems.reduce((sum, item) => sum + (item.price || 0), 0);
                const color = state.activeTab === 'INVOICE' ? 'teal' : 'indigo';
                const totalEl = document.getElementById('create-total');
                totalEl.innerText = `₹${total.toFixed(2)}`;
                totalEl.className = `text-2xl font-bold text-${color}-600`;
            },

            submit: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-save');
                const originalText = btn.innerHTML;
                
                const name = document.getElementById('input-name').value;
                if (!name || state.cartItems.some(i => !i.name)) {
                    alert('Please fill in Customer Name and Item details.');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
                btn.classList.add('bg-gray-400');
                btn.classList.remove(`bg-${state.activeTab === 'INVOICE' ? 'teal' : 'indigo'}-500`);

                const isInvoice = state.activeTab === 'INVOICE';
                const prefix = isInvoice ? 'INV' : 'QTN';
                
                const billData = {
                    billId: `${prefix}-${Date.now().toString().slice(-6)}`,
                    date: document.getElementById('input-date').value,
                    customerName: name,
                    phone: document.getElementById('input-phone').value,
                    address: document.getElementById('input-address').value,
                    items: state.cartItems,
                    total: state.cartItems.reduce((sum, i) => sum + (i.price || 0), 0),
                    type: state.activeTab
                };

                if (isInvoice) {
                    state.bills.unshift(billData);
                    await api.saveBill(billData);
                    router.navigate('dashboard');
                } else {
                    storage.saveQuotation(billData);
                    state.currentBill = billData;
                    router.navigate('detail');
                    detailHandler.show(billData);
                }
                
                btn.disabled = false;
                btn.innerHTML = originalText;
            },

            submitAgreement: (e) => {
                e.preventDefault();
                const name = document.getElementById('agmt-input-name').value;
                const address = document.getElementById('agmt-input-address').value;
                const date = document.getElementById('agmt-input-date').value;
                const payDay = document.getElementById('agmt-input-payday').value;
                
                const planValue = document.querySelector('input[name="plan"]:checked').value;
                let planName = 'Basic Plan';
                let planPrice = '₹1000 One-time';
                
                if (planValue === 'STANDARD') {
                    planName = 'Standard Plan';
                    planPrice = '₹1000 / month';
                } else if (planValue === 'ULTRA') {
                    planName = 'Ultra Plan';
                    planPrice = '₹1249 / month';
                }

                const agmtData = {
                    customerName: name,
                    address: address,
                    date: date,
                    paymentDay: payDay,
                    planName: planName,
                    planPrice: planPrice,
                    type: 'AGREEMENT'
                };

                storage.saveAgreement(agmtData);
                state.currentBill = agmtData;
                router.navigate('detail');
                detailHandler.show(agmtData);
            }
        };

        // --- Detail & PDF Logic ---
        const detailHandler = {
            show: (item) => {
                state.currentBill = item;
                router.navigate('detail');

                let color = 'teal';
                let typeText = 'INVOICE';
                
                if (item.type === 'QUOTATION') {
                    color = 'indigo';
                    typeText = 'QUOTATION';
                } else if (item.type === 'AGREEMENT') {
                    color = 'slate';
                    typeText = 'AGREEMENT';
                }
                
                // Colors
                const badge = document.getElementById('detail-type-badge');
                if (item.type === 'AGREEMENT') {
                    badge.className = `text-xs font-bold px-3 py-1.5 rounded-full bg-slate-200 text-slate-800`;
                } else {
                    badge.className = `text-xs font-bold px-3 py-1.5 rounded-full bg-${color}-100 text-${color}-700`;
                }
                badge.innerText = typeText;
                
                // Content
                document.getElementById('detail-name').innerText = item.customerName;
                document.getElementById('detail-date').innerText = new Date(item.date).toLocaleDateString();

                // Handle conditional display based on Type
                const totalRow = document.getElementById('detail-total-row');
                const itemsWrapper = document.getElementById('detail-items-wrapper');
                const planContainer = document.getElementById('detail-plan-container');
                const idDisplay = document.getElementById('detail-id');
                const phoneCont = document.getElementById('detail-phone-container');
                const addrCont = document.getElementById('detail-address-container');

                // Reset
                phoneCont.style.display = 'none';
                addrCont.style.display = 'none';
                planContainer.style.display = 'none';
                idDisplay.style.display = 'none';
                
                if (item.type === 'AGREEMENT') {
                    totalRow.style.display = 'none';
                    itemsWrapper.style.display = 'none';
                    
                    planContainer.style.display = 'flex';
                    document.getElementById('detail-plan-name').innerText = item.planName;
                    document.getElementById('detail-plan-price').innerText = item.planPrice;
                    
                    // Display monthly recurring day info
                    if(item.paymentDay) {
                         document.getElementById('detail-payday-display').innerText = `Payment due on day ${item.paymentDay} of every month`;
                    }

                    if (item.address) {
                        addrCont.style.display = 'flex';
                        document.getElementById('detail-address').innerText = item.address;
                         const addrIcon = document.getElementById('detail-address-icon');
                         addrIcon.className = `w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0 text-slate-500`;
                    }
                } 
                else {
                    // Invoice / Quote
                    totalRow.style.display = 'flex';
                    itemsWrapper.style.display = 'block';
                    idDisplay.style.display = 'inline-block';
                    idDisplay.innerText = item.billId;

                    document.getElementById('detail-total').className = `text-3xl font-bold text-${color}-600`;
                    document.getElementById('detail-total').innerText = `₹${parseFloat(item.total).toFixed(2)}`;

                    if (item.phone) {
                        phoneCont.style.display = 'flex';
                        document.getElementById('detail-phone').innerText = item.phone;
                        const phoneIcon = document.getElementById('detail-phone-icon');
                        phoneIcon.className = `w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0 text-${color}-500`;
                    }
                    if (item.address) {
                        addrCont.style.display = 'flex';
                        document.getElementById('detail-address').innerText = item.address;
                        const addrIcon = document.getElementById('detail-address-icon');
                        addrIcon.className = `w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0 text-${color}-500`;
                    }

                    // Render Items
                    const itemsContainer = document.getElementById('detail-items');
                    itemsContainer.innerHTML = '';
                    item.items.forEach(itm => {
                        const div = document.createElement('div');
                        div.className = 'py-4 flex justify-between items-center';
                        div.innerHTML = `
                            <span class="text-gray-700 font-medium text-sm">${itm.name}</span>
                            <span class="text-dark font-bold text-sm">₹${parseFloat(itm.price).toFixed(2)}</span>
                        `;
                        itemsContainer.appendChild(div);
                    });
                }
                
                // Button Styling
                const btnDownload = document.getElementById('btn-download-pdf');
                const btnShare = document.getElementById('btn-share-pdf');
                const btnPrint = document.getElementById('btn-print');

                if (item.type === 'AGREEMENT') {
                    btnDownload.className = `bg-slate-700 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1`;
                    btnShare.className = `bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1`;
                } else {
                    btnDownload.className = `bg-${color}-500 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1`;
                    btnShare.className = `bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 flex flex-col items-center justify-center gap-1 opacity-90 hover:opacity-100`;
                }
            }
        };

        const templateRenderer = {
            update: (bill) => {
                const isQuote = bill.type === 'QUOTATION';
                const themeColor = isQuote ? '#6366f1' : '#00c7a4';
                const label = isQuote ? 'QUOTATION' : 'INVOICE';

                document.getElementById('pdf-header-border').style.borderBottom = `2px solid ${themeColor}`;
                
                document.getElementById('pdf-doc-label').innerText = label;
                document.getElementById('pdf-bill-id').innerText = `#${bill.billId}`;
                document.getElementById('pdf-bill-date').innerText = new Date(bill.date).toLocaleDateString('en-GB');
                
                document.getElementById('pdf-to-label').innerText = isQuote ? 'Quote For' : 'Bill To';
                document.getElementById('pdf-customer-name').innerText = bill.customerName;
                
                const pdfPhone = document.getElementById('pdf-customer-phone');
                const pdfAddr = document.getElementById('pdf-customer-address');
                
                pdfPhone.style.display = bill.phone ? 'block' : 'none';
                if(bill.phone) pdfPhone.innerText = bill.phone;
                
                pdfAddr.style.display = bill.address ? 'block' : 'none';
                if(bill.address) pdfAddr.innerText = bill.address;

                document.getElementById('pdf-table-header').style.borderBottom = `2px solid #e2e8f0`;

                const tbody = document.getElementById('pdf-items-body');
                tbody.innerHTML = '';
                bill.items.forEach((item, idx) => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f1f5f9';
                    tr.innerHTML = `
                        <td style="padding: 12px 15px; color: #94a3b8; font-size: 13px;">${idx + 1}</td>
                        <td style="padding: 12px 15px; color: #334155; font-weight: 500; font-size: 14px;">${item.name}</td>
                        <td style="padding: 12px 15px; text-align: right; font-weight: bold; color: #0f172a; font-size: 14px; font-family: monospace;">${parseFloat(item.price).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('pdf-subtotal').innerText = `₹${parseFloat(bill.total).toFixed(2)}`;
                document.getElementById('pdf-total-container').style.borderBottom = `2px solid ${themeColor}`;
                const totalEl = document.getElementById('pdf-total');
                totalEl.innerText = `₹${parseFloat(bill.total).toFixed(2)}`;
                totalEl.style.color = themeColor;
                document.getElementById('pdf-total-label').style.color = themeColor;
                
                document.getElementById('pdf-footer-brand').style.color = themeColor;
                document.getElementById('pdf-terms').innerText = isQuote 
                    ? 'This quotation is valid for 14 days.' 
                    : 'Payment is due upon receipt. Please make checks payable to NextGen.';
            },
            
            updateAgreement: (item) => {
                 document.getElementById('agmt-client').innerText = item.customerName;
                 document.getElementById('agmt-sign-client').innerText = item.customerName;
                 document.getElementById('agmt-address').innerText = item.address || '';
                 document.getElementById('agmt-date').innerText = new Date(item.date).toLocaleDateString('en-GB');
                 document.getElementById('agmt-plan-name').innerText = item.planName.toUpperCase();
                 document.getElementById('agmt-plan-price').innerText = item.planPrice;
                 
                 // Update Service Description based on Plan
                 const plan = item.planName; // 'Basic Plan', 'Standard Plan', 'Ultra Plan'
                 let serviceHtml = '';

                 if (plan === 'Basic Plan') {
                    // Essential features from image
                    serviceHtml = `
                        Provision of a simple, elegant QR menu for showcasing offerings.<br>
                        Features include:<br>
                        • <strong>Showcase QR Menu:</strong> Digital menu display.<br>
                        • <strong>NextGen Branding:</strong> Default branding applied.<br>
                        <em style="color:#64748b; font-size:9px;">(Note: Does not include Live Order System or Personalized Branding)</em>
                    `;
                 } else if (plan === 'Standard Plan') {
                    // Pro features from image
                    serviceHtml = `
                        Provision of a complete system to manage and streamline restaurant operations.<br>
                        Features include:<br>
                        • <strong>Dynamic QR Menu:</strong> Real-time menu updates.<br>
                        • <strong>Full Management System:</strong> Comprehensive backend control.<br>
                        • <strong>Bill & Table Management:</strong> Order processing and table tracking.<br>
                        <em style="color:#64748b; font-size:9px;">(Note: Does not include Personalized Branding)</em>
                    `;
                 } else if (plan === 'Ultra Plan') {
                    // Ultimate features from image
                    serviceHtml = `
                        Provision of a fully white-label solution with custom branding.<br>
                        Features include:<br>
                        • <strong>Everything in Standard Plan:</strong> Includes Dynamic QR Menu, Management System, and Billing.<br>
                        • <strong>Personalized Branding:</strong> Custom brand identity.<br>
                        • <strong>Your Own Logo:</strong> Custom logo placement.<br>
                        • <strong>Auto Festival Themes:</strong> Automated thematic updates.
                    `;
                 }
                 
                 document.getElementById('agmt-service-desc').innerHTML = serviceHtml;

                 // Format Payment Day string
                 let payString = 'Upon Receipt';
                 if (item.paymentDay) {
                     // Add suffix (st, nd, rd, th)
                     const day = parseInt(item.paymentDay);
                     let suffix = 'th';
                     if (day % 10 === 1 && day !== 11) suffix = 'st';
                     else if (day % 10 === 2 && day !== 12) suffix = 'nd';
                     else if (day % 10 === 3 && day !== 13) suffix = 'rd';
                     
                     payString = `Recurring monthly payment due on the ${day}${suffix} of every month.`;
                 }
                 document.getElementById('agmt-paydate').innerText = payString;
            }
        };

        const outputHandler = {
            // Helper function to generate PDF blob/file for both Download and Share
            // Now accepts optional templateId (default: #pdf-template)
            _generatePdfInstance: async (item, templateId) => {
                
                // 1. Prepare template
                if (templateId === 'agreement-template') {
                    templateRenderer.updateAgreement(item);
                } else {
                    templateRenderer.update(item);
                }

                const template = document.getElementById(templateId);
                const clone = template.cloneNode(true);
                
                // Styling for off-screen rendering
                clone.style.position = 'absolute';
                clone.style.left = '0';
                clone.style.top = '0';
                clone.style.zIndex = '-9999';
                clone.style.margin = '0';
                clone.style.width = '794px'; 
                clone.style.display = 'block';
                document.body.appendChild(clone);

                try {
                    // 2. HTML to Canvas
                    const canvas = await html2canvas(clone, {
                        scale: 2, 
                        windowWidth: 794,
                        width: 794,
                        x: 0,
                        y: 0,
                        scrollY: 0,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });

                    // 3. Canvas to PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    return pdf;

                } finally {
                    // Cleanup
                    if (document.body.contains(clone)) {
                        document.body.removeChild(clone);
                    }
                }
            },

            print: () => {
                const item = state.currentBill;
                if (!item) return;
                
                if (item.type === 'AGREEMENT') {
                    templateRenderer.updateAgreement(item);
                } else {
                    templateRenderer.update(item);
                }
                setTimeout(() => window.print(), 100);
            },

            // Updated Share to handle both Agreement and Invoice based on context/button logic
            share: async () => {
                 const item = state.currentBill;
                 if (!item) return;
                 
                 const isAgreement = item.type === 'AGREEMENT';
                 const btn = document.getElementById('btn-share-pdf');
                 const originalContent = btn.innerHTML;
                 btn.disabled = true;
                 btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i><span class="text-[10px]">Sharing...</span>';

                 try {
                     // 1. Generate PDF
                     const templateId = isAgreement ? 'agreement-template' : 'pdf-template';
                     const pdf = await outputHandler._generatePdfInstance(item, templateId);
                     
                     // 2. Create File Object
                     const blob = pdf.output('blob');
                     const sanitizedName = (item.customerName || 'customer').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                     const dateStr = new Date(item.date).toISOString().split('T')[0];
                     const typeStr = isAgreement ? 'agreement' : 'bill';
                     const filename = `nextgen-${typeStr}-${sanitizedName}-${dateStr}.pdf`;
                     
                     const file = new File([blob], filename, { type: 'application/pdf' });

                     // 3. Share
                     const shareData = {
                         files: [file],
                         title: isAgreement ? 'Agreement for ' + item.customerName : 'Bill ' + item.billId,
                         text: isAgreement ? `SaaS Agreement for ${item.customerName}.` : `Please find attached the bill for ${item.customerName}.`
                     };

                     if (navigator.canShare && navigator.canShare(shareData)) {
                         await navigator.share(shareData);
                     } else {
                         // Fallback logic if sharing files isn't supported
                         alert("Sharing files is not supported on this browser. Downloading instead.");
                         pdf.save(filename);
                     }

                 } catch (error) {
                     console.error(error);
                     alert("Share failed: " + error.message);
                 } finally {
                     btn.disabled = false;
                     btn.innerHTML = originalContent;
                 }
            },
            
            download: async () => {
                const item = state.currentBill;
                if (!item) return;
                
                const isAgreement = item.type === 'AGREEMENT';
                const btn = document.getElementById('btn-download-pdf');
                
                // Temporarily show spinner inside the PDF button structure
                btn.disabled = true;
                const oldIcon = btn.querySelector('i').className;
                const oldText = btn.querySelector('span').innerText;
                
                btn.querySelector('span').innerText = 'Generating...';
                btn.querySelector('i').className = 'fas fa-spinner fa-spin text-sm';

                try {
                    const templateId = isAgreement ? 'agreement-template' : 'pdf-template';
                    const pdf = await outputHandler._generatePdfInstance(item, templateId);
                    
                    const sanitizedName = (item.customerName || 'customer').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    const dateStr = new Date(item.date).toISOString().split('T')[0];
                    const typeStr = isAgreement ? 'agreement' : 'bill';
                    
                    pdf.save(`nextgen-${typeStr}-${sanitizedName}-${dateStr}.pdf`);

                } catch (error) {
                    console.error(error);
                    alert('PDF Generation failed: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.querySelector('span').innerText = oldText;
                    btn.querySelector('i').className = oldIcon;
                }
            }
        };
    </script>
</body>
</html>
