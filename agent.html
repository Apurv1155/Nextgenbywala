<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SoloCRM</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
                400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
              }
            },
            animation: { 'slide-up': 'slideUp 0.3s ease-out forwards', 'fade-in': 'fadeIn 0.3s ease-out forwards' },
            keyframes: {
              slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
            }
          }
        }
      }
    </script>

    <style>
      /* Hide Scrollbars */
      ::-webkit-scrollbar { display: none; }
      * { -ms-overflow-style: none; scrollbar-width: none; }
      
      body { 
          background-color: #f8fafc; 
          -webkit-tap-highlight-color: transparent; 
          overscroll-behavior-y: none; 
          font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      }

      /* SortableJS Classes */
      .sortable-ghost { opacity: 0.4; background: #eff6ff; border: 2px dashed #3b82f6; }
      
      /* Dragging visual feedback */
      .sortable-drag { 
          cursor: grabbing; 
          opacity: 1; 
          background: white; 
          transform: rotate(3deg) scale(1.02); 
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2) !important; 
          z-index: 9999 !important; 
      }
      
      /* Snap scrolling for Kanban */
      .snap-x-mandatory {
          scroll-snap-type: x mandatory;
      }
      .snap-center {
          scroll-snap-align: center;
          scroll-snap-stop: always; /* Ensure we stop exactly on a column */
      }

      /* Disable snap and smoothing during drag to allow JS auto-scroll */
      .no-snap {
          scroll-snap-type: none !important;
          scroll-behavior: auto !important;
      }
      
      .chat-bubble { animation: fadeIn 0.3s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "recharts": "https://esm.sh/recharts@^3.5.1",
    "xlsx": "https://esm.sh/xlsx@^0.18.5"
  }
}
</script>
</head>
<body class="text-slate-900 selection:bg-blue-100 selection:text-blue-900">

    <div id="app" class="flex flex-col h-screen">
        
        <!-- Header -->
        <header class="h-20 md:h-24 bg-slate-50/90 backdrop-blur-md flex items-center justify-between px-4 md:px-8 shrink-0 z-10 sticky top-0 border-b border-transparent transition-all">
            <div class="flex items-center">
                <img src="https://placehold.co/258x65/png?text=SoloCRM" alt="Logo" class="h-10 md:h-12 w-auto object-contain" />
            </div>
            <!-- Desktop User Indicator -->
            <div class="hidden md:flex items-center gap-3 px-4 py-2 text-xs text-slate-400 bg-white/50 rounded-lg border border-slate-100">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                System Online
            </div>
        </header>

        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col fixed left-0 top-24 bottom-0 w-64 bg-slate-50 border-r border-slate-200/50 p-4 z-20">
            <div class="space-y-1" id="desktop-nav">
                <!-- Nav Items injected here -->
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto overflow-x-hidden relative scroll-smooth md:ml-64">
            <!-- Dynamic Page Content -->
        </main>

        <!-- Bottom Navigation (Mobile) -->
        <nav class="md:hidden h-16 bg-white border-t border-slate-200 flex justify-around items-center shrink-0 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)] z-30" id="mobile-nav">
            <!-- Nav Items injected here -->
        </nav>

    </div>

    <!-- Agent Floating Button -->
    <button onclick="openAgentModal()" class="fixed bottom-24 md:bottom-10 left-4 md:left-[280px] bg-slate-900 text-white p-4 rounded-full shadow-xl hover:bg-slate-800 transition-transform active:scale-95 z-40 flex items-center gap-2 group">
        <i data-lucide="bot" width="24"></i>
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap text-sm font-bold">Ask Jerry</span>
    </button>

    <!-- MODALS -->

    <!-- Agent Modal -->
    <div id="agent-modal" class="hidden fixed inset-0 z-50 flex items-end md:items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal('agent-modal')"></div>
        <div class="relative bg-white w-full md:max-w-md md:rounded-2xl rounded-t-3xl shadow-2xl flex flex-col animate-slide-up h-[80vh] md:h-[70vh]">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-50 bg-slate-50 rounded-t-3xl md:rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white">
                        <i data-lucide="bot" width="20"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Jerry</h2>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Online</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeModal('agent-modal')" class="p-2 bg-white hover:bg-red-50 text-gray-500 hover:text-red-600 rounded-full border border-gray-100">
                    <i data-lucide="x" width="18"></i>
                </button>
            </div>
            
            <!-- Chat Area -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50" id="agent-chat-area">
                <!-- Messages go here -->
            </div>

            <!-- Options Area (No Typing) -->
            <div class="p-4 bg-white border-t border-gray-100 pb-safe">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Suggested Actions:</p>
                    <button onclick="resetAgentOptions()" class="text-[10px] text-blue-600 font-bold hover:underline">Main Menu</button>
                </div>
                <div class="flex flex-wrap gap-2" id="agent-options">
                    <!-- Chips go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Details Modal -->
    <div id="lead-modal" class="hidden fixed inset-0 z-50 flex items-end md:items-center justify-center">
        <div class="absolute inset-0 bg-brand-900/20 backdrop-blur-sm transition-opacity" onclick="closeModal('lead-modal')"></div>
        <div class="relative bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-3xl shadow-2xl flex flex-col animate-slide-up h-[92vh] md:h-auto md:max-h-[85vh]">
            <!-- Handle -->
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="closeModal('lead-modal')">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
            </div>
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-50">
                <h2 class="text-xl font-bold text-gray-800 tracking-tight">Lead Profile</h2>
                <button onclick="closeModal('lead-modal')" class="p-2 bg-gray-50 hover:bg-brand-50 text-gray-500 hover:text-brand-600 rounded-full transition-colors">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="overflow-y-auto p-6 flex-1 bg-white" id="lead-modal-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="add-modal" class="hidden fixed inset-0 z-50 flex items-end md:items-center justify-center">
        <div class="absolute inset-0 bg-brand-900/20 backdrop-blur-sm transition-opacity" onclick="closeModal('add-modal')"></div>
        <div class="relative bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-3xl shadow-2xl flex flex-col animate-slide-up h-auto pb-6">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-50">
                <h2 class="text-xl font-bold text-gray-800">New Lead</h2>
                <button onclick="closeModal('add-modal')" class="p-2 bg-gray-50 hover:bg-red-50 text-gray-500 hover:text-red-600 rounded-full">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-100 px-6">
                <button id="tab-manual" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors" onclick="switchTab('manual')">Manual Entry</button>
                <button id="tab-import" class="flex-1 py-4 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-colors" onclick="switchTab('import')">Import Excel</button>
            </div>

            <div class="p-6">
                <!-- Manual Form -->
                <form id="add-lead-form" class="space-y-4">
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-3.5 text-slate-400" width="18"></i>
                        <input name="name" required class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Full Name">
                    </div>
                    <div class="relative">
                        <i data-lucide="briefcase" class="absolute left-3 top-3.5 text-slate-400" width="18"></i>
                        <input name="company" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Company Name">
                    </div>
                    <div class="relative">
                        <i data-lucide="phone" class="absolute left-3 top-3.5 text-slate-400" width="18"></i>
                        <input name="phone" type="tel" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Phone Number">
                    </div>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3.5 text-slate-400" width="18"></i>
                        <input name="email" type="email" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Email Address">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 mt-6 shadow-lg shadow-blue-200 flex justify-center items-center gap-2">
                        <i data-lucide="user-plus" width="20"></i> Create Lead
                    </button>
                </form>

                <!-- Import Form -->
                <div id="import-form" class="hidden space-y-5 animate-fade-in">
                    <div class="border-2 border-dashed border-blue-200 rounded-2xl p-8 text-center bg-blue-50/50 relative group transition-colors hover:bg-blue-50">
                        <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileUpload(this)">
                        <div class="pointer-events-none">
                            <div class="bg-white w-16 h-16 rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="upload-cloud" class="text-blue-500" width="32"></i>
                            </div>
                            <p class="text-base font-bold text-slate-800">Click to Upload Excel</p>
                            <p class="text-xs text-slate-500 mt-2">Supports .xlsx, .xls, .csv</p>
                            <div class="mt-4 text-[10px] text-slate-400 bg-white p-2 rounded-lg border border-slate-100 inline-block text-left">
                                <strong>Required Columns:</strong><br/>
                                Business Name, Mobile Number, Address, Google Maps, Rating
                            </div>
                        </div>
                    </div>
                    
                    <div id="import-preview" class="hidden bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-emerald-100 text-emerald-600 p-2 rounded-lg">
                                    <i data-lucide="file-spreadsheet" width="20"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">File Ready</p>
                                    <p class="text-xs text-slate-500">Found <span id="import-count" class="font-bold text-emerald-600">0</span> potential leads</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="confirmImport()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl hover:bg-emerald-600 shadow-lg shadow-emerald-200 flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="check-circle" width="18"></i> Import Leads
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- 1. CONSTANTS & TYPES ---
        const LeadStatus = {
            NEW: 'New', CONTACTED: 'Contacted', FOLLOW_UP: 'Follow-Up', 
            INTERESTED: 'Interested', WON: 'Won', LOST: 'Lost'
        };
        const InteractionType = { CALL: 'Call', WHATSAPP: 'WhatsApp', EMAIL: 'Email', NOTE: 'Note' };
        
        const COLUMNS = [
            { id: LeadStatus.NEW, title: 'New' }, { id: LeadStatus.CONTACTED, title: 'Contacted' },
            { id: LeadStatus.FOLLOW_UP, title: 'Follow Up' }, { id: LeadStatus.INTERESTED, title: 'Interested' },
            { id: LeadStatus.WON, title: 'Won' }, { id: LeadStatus.LOST, title: 'Lost' }
        ];

        // --- 2. DATABASE SERVICE (Local Storage) ---
        class Database {
            constructor() {
                this.KEYS = { LEADS: 'solocrm_leads', TASKS: 'solocrm_tasks', INTERACTIONS: 'solocrm_interactions', CLIENTS: 'solocrm_clients' };
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.KEYS.LEADS)) {
                    const initialLeads = [
                        { id: '1', name: 'Alice Smith', phone: '5551234567', email: 'alice@example.com', status: LeadStatus.NEW, createdAt: Date.now(), company: 'Tech Corp' },
                        { id: '2', name: 'Bob Jones', phone: '5559876543', email: 'bob@example.com', status: LeadStatus.CONTACTED, createdAt: Date.now() - 86400000, company: 'Bakery Inc' },
                        { id: '3', name: 'Charlie Day', phone: '5551112222', email: 'charlie@example.com', status: LeadStatus.FOLLOW_UP, createdAt: Date.now() - 172800000 },
                    ];
                    localStorage.setItem(this.KEYS.LEADS, JSON.stringify(initialLeads));
                }
                if (!localStorage.getItem(this.KEYS.TASKS)) {
                    localStorage.setItem(this.KEYS.TASKS, JSON.stringify([
                        { id: '101', title: 'Call Alice about proposal', dueDate: Date.now() + 3600000, isCompleted: false, priority: 'high', leadId: '1' }
                    ]));
                }
            }

            load(key) { return JSON.parse(localStorage.getItem(key) || '[]'); }
            save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

            getLeads() { return this.load(this.KEYS.LEADS); }
            saveLeads(leads) { this.save(this.KEYS.LEADS, leads); }
            
            getTasks() { return this.load(this.KEYS.TASKS); }
            saveTasks(tasks) { this.save(this.KEYS.TASKS, tasks); }

            getInteractions() { return this.load(this.KEYS.INTERACTIONS); }
            
            getClients() { return this.load(this.KEYS.CLIENTS); }

            addInteraction(interaction) {
                const ints = this.getInteractions();
                ints.push(interaction);
                this.save(this.KEYS.INTERACTIONS, ints);
                
                // Update Lead Last Interaction
                const leads = this.getLeads();
                const lead = leads.find(l => l.id === interaction.leadId);
                if (lead) {
                    lead.lastInteraction = interaction.timestamp;
                    this.saveLeads(leads);
                }
            }

            addLead(lead) {
                const leads = this.getLeads();
                leads.push(lead);
                this.saveLeads(leads);
            }

            deleteLead(id) {
                const leads = this.getLeads().filter(l => l.id !== id);
                this.saveLeads(leads);
            }

            createClient(lead) {
                const clients = this.getClients();
                if (clients.find(c => c.leadId === lead.id)) return;
                clients.push({
                    id: crypto.randomUUID(),
                    leadId: lead.id,
                    name: lead.name,
                    serviceType: 'General Service',
                    renewalDate: Date.now() + (30 * 24 * 60 * 60 * 1000),
                    paymentNotes: 'Pending setup'
                });
                this.save(this.KEYS.CLIENTS, clients);
            }
        }

        const db = new Database();

        // --- 3. UI RENDERERS ---

        function renderNav() {
            const routes = [
                { id: 'dashboard', icon: 'layout-dashboard', label: 'Dash' },
                { id: 'leads', icon: 'users', label: 'Leads' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'clients', icon: 'briefcase', label: 'Clients' }
            ];
            const current = location.hash.replace('#', '') || 'dashboard';

            // Desktop
            document.getElementById('desktop-nav').innerHTML = routes.map(r => `
                <a href="#${r.id}" class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${current === r.id ? 'bg-blue-50 text-blue-700 shadow-sm border border-blue-100' : 'text-slate-600 hover:bg-white'}">
                    <i data-lucide="${r.icon}" width="20"></i> ${r.label}
                </a>
            `).join('');

            // Mobile
            document.getElementById('mobile-nav').innerHTML = routes.map(r => `
                <a href="#${r.id}" class="flex flex-col items-center justify-center w-full h-full gap-1 ${current === r.id ? 'text-blue-600' : 'text-slate-400'}">
                    <i data-lucide="${r.icon}" width="${current === r.id ? 24 : 22}"></i>
                    <span class="text-[10px] font-medium">${r.label}</span>
                </a>
            `).join('');
            
            lucide.createIcons();
        }

        async function renderDashboard() {
            const leads = db.getLeads();
            const tasks = db.getTasks();
            const interactions = db.getInteractions();

            const counts = {};
            Object.values(LeadStatus).forEach(s => counts[s] = 0);
            leads.forEach(l => counts[l.status] = (counts[l.status] || 0) + 1);

            const urgentTasks = tasks.filter(t => !t.isCompleted && (t.priority === 'high' || t.dueDate < Date.now() + 86400000));
            const maxCount = Math.max(...Object.values(counts), 1);

            // Activity Today
            const today = new Date().setHours(0,0,0,0);
            const todayInts = interactions.filter(i => i.timestamp >= today);
            const activity = {
                calls: todayInts.filter(i => i.type === InteractionType.CALL).length,
                msgs: todayInts.filter(i => i.type === InteractionType.WHATSAPP).length,
                emails: todayInts.filter(i => i.type === InteractionType.EMAIL).length
            };

            const html = `
                <div class="p-4 md:p-8 w-full max-w-[1800px] mx-auto space-y-6 pb-24 md:pb-12">
                    <div class="flex flex-col gap-1 mb-2">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Dashboard</h1>
                        <p class="text-slate-500 text-sm">Welcome back, Founder.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 md:gap-6">
                        <!-- Gradient Card for New Leads -->
                        <div class="bg-gradient-to-br from-blue-600 to-blue-500 p-5 rounded-2xl shadow-lg text-white">
                            <div class="flex items-center gap-2 mb-3 text-blue-100"><i data-lucide="sparkles" width="18"></i> New Leads</div>
                            <p class="text-4xl font-bold tracking-tight">${counts[LeadStatus.NEW]}</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex items-center gap-2 mb-3 text-slate-500"><i data-lucide="users" width="18"></i> Total Leads</div>
                            <p class="text-4xl font-bold text-slate-800 tracking-tight">${leads.length}</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm col-span-2 sm:col-span-1">
                            <div class="flex items-center gap-2 mb-3 text-emerald-600"><i data-lucide="trophy" width="18"></i> Won Deals</div>
                            <p class="text-4xl font-bold text-slate-800 tracking-tight">${counts[LeadStatus.WON]}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Activity -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h2 class="font-bold text-lg mb-5 flex gap-2 items-center"><i data-lucide="activity" class="text-blue-500" width="20"></i> Today's Actions</h2>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center hover:bg-slate-100 transition-colors">
                                    <i data-lucide="phone" class="text-blue-500 mx-auto mb-2" width="24"></i>
                                    <span class="text-3xl font-bold block text-slate-800">${activity.calls}</span>
                                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Calls</span>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center hover:bg-slate-100 transition-colors">
                                    <i data-lucide="message-circle" class="text-emerald-500 mx-auto mb-2" width="24"></i>
                                    <span class="text-3xl font-bold block text-slate-800">${activity.msgs}</span>
                                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Msgs</span>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center hover:bg-slate-100 transition-colors">
                                    <i data-lucide="mail" class="text-indigo-500 mx-auto mb-2" width="24"></i>
                                    <span class="text-3xl font-bold block text-slate-800">${activity.emails}</span>
                                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Emails</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pipeline -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h2 class="font-bold text-lg mb-5 flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-slate-400" width="20"></i> Pipeline</h2>
                            <div class="space-y-4">
                                ${Object.entries(counts).map(([status, count]) => {
                                    if(count === 0 && status !== 'New') return '';
                                    const pct = (count / maxCount) * 100;
                                    const color = status === 'New' ? 'bg-blue-500' : status === 'Won' ? 'bg-emerald-500' : 'bg-slate-400';
                                    return `
                                        <div>
                                            <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-600 uppercase tracking-wide"><span>${status}</span><span>${count}</span></div>
                                            <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                                <div class="h-full rounded-full ${color}" style="width: ${pct}%"></div>
                                            </div>
                                        </div>
                                    `
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tasks List (Simplified) -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-0 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                            <h2 class="font-bold text-slate-800 flex gap-2 items-center"><i data-lucide="check-circle" class="text-slate-400" width="20"></i> Priority Tasks</h2>
                            ${urgentTasks.length > 0 ? `<span class="bg-red-100 text-red-700 text-xs font-bold px-2.5 py-1 rounded-full">${urgentTasks.length} Due</span>` : ''}
                        </div>
                        <div class="p-2">
                             ${urgentTasks.length === 0 ? '<p class="text-slate-400 text-center py-8 text-sm">All caught up! Great job.</p>' : urgentTasks.map(t => `
                                <div class="flex gap-4 items-center p-4 hover:bg-slate-50 rounded-xl transition-colors border-b last:border-0 border-slate-50">
                                    <div class="w-1.5 h-12 bg-red-400 rounded-full shrink-0"></div>
                                    <div class="flex-1">
                                        <p class="text-base font-semibold text-slate-800">${t.title}</p>
                                        <div class="flex gap-3 mt-1 items-center">
                                            <span class="text-xs text-slate-500 flex items-center gap-1"><i data-lucide="calendar" width="12"></i> ${new Date(t.dueDate).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                    <button onclick="toggleTask('${t.id}')" class="p-2 text-slate-300 hover:text-blue-600 transition-colors">
                                        <i data-lucide="check" width="20"></i>
                                    </button>
                                </div>
                             `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        // --- 4. MOBILE AUTO-SLIDE LOGIC (CONTINUOUS EDGE SCROLL) ---
        let isDraggingLead = false;
        let currentTouchX = 0;

        function initAutoScrollLogic() {
            // Update touch position globally when dragging
            window.addEventListener('touchmove', (e) => {
                if (isDraggingLead && e.touches[0]) {
                    currentTouchX = e.touches[0].clientX;
                }
            }, { passive: true });
        }

        function checkAutoSlide() {
            // Only run if dragging
            if (!isDraggingLead) return;

            const board = document.getElementById('kanban-board');
            if (!board) return;

            const viewportWidth = window.innerWidth;
            const threshold = 80; // Distance from edge to trigger scroll
            
            let scrollAmount = 0;

            if (currentTouchX > (viewportWidth - threshold)) {
                // Near Right Edge -> Scroll Right
                scrollAmount = 8; 
            } else if (currentTouchX < threshold && currentTouchX > 0) {
                // Near Left Edge -> Scroll Left
                scrollAmount = -8;
            }

            if (scrollAmount !== 0) {
                board.scrollLeft += scrollAmount;
            }
            
            // Loop while dragging
            requestAnimationFrame(checkAutoSlide);
        }

        // Initialize listeners once
        initAutoScrollLogic();

        function renderLeads() {
            const leads = db.getLeads();
            const colsHtml = COLUMNS.map(col => {
                const colLeads = leads.filter(l => l.status === col.id);
                return `
                    <div class="flex flex-col h-full w-full shrink-0 md:w-96 snap-center snap-stop-always bg-slate-50 md:bg-transparent md:rounded-none">
                        <div class="p-4 md:p-3 sticky top-0 z-10 flex justify-between items-center backdrop-blur-sm">
                            <h3 class="font-bold text-slate-700 text-sm uppercase flex items-center gap-2">
                                <div class="w-2.5 h-2.5 rounded-full ${colLeads.length ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                                ${col.title}
                            </h3>
                            <span class="bg-white px-2 py-1 rounded text-xs font-bold text-slate-600 shadow-sm">${colLeads.length}</span>
                        </div>
                        <div class="flex-1 p-4 md:p-2 overflow-y-auto kanban-col" data-status="${col.id}">
                            ${colLeads.map(l => {
                                const rawPhone = l.phone.replace(/\D/g, '');
                                const waPhone = rawPhone.length === 10 ? '91' + rawPhone : rawPhone;
                                
                                return `
                                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-3 touch-manipulation group hover:border-blue-300 relative pl-10" data-id="${l.id}" onclick="openLeadModal('${l.id}')">
                                    <!-- Drag Handle -->
                                    <div class="drag-handle absolute left-0 top-0 bottom-0 w-10 flex items-center justify-center cursor-grab active:cursor-grabbing touch-none text-slate-300 hover:text-blue-500 bg-gray-50/50 rounded-l-xl border-r border-gray-50">
                                        <i data-lucide="grip-vertical" width="20"></i>
                                    </div>

                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-semibold text-gray-900 truncate text-base">${l.name}</h3>
                                        <span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">${new Date(l.createdAt).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                                    </div>
                                    ${l.company ? `<div class="flex items-center gap-1 text-xs text-gray-500 mb-2"><i data-lucide="briefcase" width="12"></i> ${l.company}</div>` : ''}
                                    
                                    <div class="pt-2 border-t border-gray-50 flex gap-2" onclick="event.stopPropagation()">
                                        <a href="tel:${l.phone}" onclick="logAction('${l.id}', 'Call')" class="p-2 rounded-full bg-green-50 text-green-700 hover:bg-green-100"><i data-lucide="phone" width="16"></i></a>
                                        <a href="https://wa.me/${waPhone}" target="_blank" onclick="logAction('${l.id}', 'WhatsApp')" class="p-2 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100"><i data-lucide="message-circle" width="16"></i></a>
                                        <a href="mailto:${l.email}" onclick="logAction('${l.id}', 'Email')" class="p-2 rounded-full bg-blue-50 text-blue-700 hover:bg-blue-100"><i data-lucide="mail" width="16"></i></a>
                                        <button onclick="openLeadModal('${l.id}')" class="p-2 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 ml-auto" title="View Details">
                                            <i data-lucide="file-text" width="16"></i>
                                        </button>
                                    </div>
                                </div>
                            `}).join('')}
                            <div class="h-10"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Mobile Scroll Dots
            const dotsHtml = `
                <div class="md:hidden absolute bottom-20 left-0 right-0 flex justify-center gap-2 pointer-events-none z-20" id="kanban-dots">
                    ${COLUMNS.map((_, i) => `<div class="w-1.5 h-1.5 rounded-full transition-all duration-300 ${i === 0 ? 'bg-blue-600 w-3' : 'bg-slate-300'}"></div>`).join('')}
                </div>
            `;

            document.getElementById('main-content').innerHTML = `
                <div class="h-full flex flex-col relative bg-white md:bg-slate-50/50 overflow-hidden">
                    <div class="flex-1 flex flex-row overflow-x-auto overflow-y-hidden snap-x-mandatory scroll-smooth p-0 md:p-6 gap-0 md:gap-6" id="kanban-board">
                        ${colsHtml}
                    </div>
                    ${dotsHtml}
                    <button onclick="openAddModal()" class="fixed bottom-24 md:bottom-10 right-4 md:right-10 bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition-transform active:scale-95 z-40">
                        <i data-lucide="plus" width="28"></i>
                    </button>
                </div>
            `;

            // Scroll Listener for Dots
            const board = document.getElementById('kanban-board');
            const dotsContainer = document.getElementById('kanban-dots');
            
            if(board && dotsContainer) {
                board.addEventListener('scroll', () => {
                    const scrollLeft = board.scrollLeft;
                    const colWidth = board.offsetWidth;
                    const index = Math.round(scrollLeft / colWidth);
                    
                    Array.from(dotsContainer.children).forEach((dot, i) => {
                        if (i === index) {
                            dot.className = "w-3 h-1.5 rounded-full transition-all duration-300 bg-blue-600";
                        } else {
                            dot.className = "w-1.5 h-1.5 rounded-full transition-all duration-300 bg-slate-300";
                        }
                    });
                });
            }

            // Capture board for Sortable scroll option
            const boardEl = document.getElementById('kanban-board');

            // Initialize SortableJS
            document.querySelectorAll('.kanban-col').forEach(col => {
                new Sortable(col, {
                    group: 'leads',
                    animation: 200,
                    
                    // --- Handle Based Dragging (Fixed for Mobile) ---
                    handle: '.drag-handle', // Only drag when handle is touched
                    delay: 0, // No delay required when using a handle
                    touchStartThreshold: 5, 
                    
                    ghostClass: 'sortable-ghost',
                    
                    // --- Fallback Mode ---
                    forceFallback: true, 
                    fallbackOnBody: true, 
                    dragClass: 'sortable-drag', 
                    
                    // --- NATIVE SORTABLE AUTO-SCROLL OVERRIDDEN BY MANUAL SLIDE LOGIC ---
                    scroll: false, // Turn off native scroll to avoid conflicts
                    
                    onStart: function(evt) {
                        // Disable snap during drag to prevent conflict with continuous auto-scroll
                        boardEl.classList.add('no-snap');
                        if (navigator.vibrate) navigator.vibrate(50);
                        
                        // Start Manual Auto-Slide
                        isDraggingLead = true;
                        
                        // Initialize x to avoid jump
                        if (evt.originalEvent.touches && evt.originalEvent.touches[0]) {
                            currentTouchX = evt.originalEvent.touches[0].clientX;
                        } else {
                            currentTouchX = evt.originalEvent.clientX;
                        }
                        
                        // Kick off the loop
                        requestAnimationFrame(checkAutoSlide);
                    },
                    
                    onEnd: function (evt) {
                        // Re-enable snap so the view settles nicely on a column
                        boardEl.classList.remove('no-snap');
                        
                        // Stop Manual Auto-Slide
                        isDraggingLead = false;

                        const itemEl = evt.item;
                        const newStatus = evt.to.getAttribute('data-status');
                        const oldStatus = evt.from.getAttribute('data-status');
                        const leadId = itemEl.getAttribute('data-id');

                        if (newStatus !== oldStatus) {
                            const leads = db.getLeads();
                            const lead = leads.find(l => l.id === leadId);
                            if (lead) {
                                lead.status = newStatus;
                                db.saveLeads(leads);
                                db.addInteraction({
                                    id: crypto.randomUUID(), leadId, type: InteractionType.NOTE, 
                                    content: `Moved status from ${oldStatus} to ${newStatus}`, timestamp: Date.now()
                                });
                                if (newStatus === LeadStatus.WON) {
                                    db.createClient(lead);
                                }
                            }
                        }
                    }
                });
            });
        }

        function renderTasks() {
            const tasks = db.getTasks().sort((a, b) => Number(a.isCompleted) - Number(b.isCompleted) || a.dueDate - b.dueDate);
            const html = `
                <div class="p-4 md:p-10 w-full max-w-6xl mx-auto pb-20">
                    <h1 class="text-3xl font-bold mb-8">Tasks</h1>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <form onsubmit="addTask(event)" class="p-6 bg-slate-50 border-b border-slate-100 flex flex-col md:flex-row gap-4">
                            <input id="new-task-title" required type="text" placeholder="Add a new task..." class="flex-1 px-5 py-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-100">
                            <div class="flex gap-3">
                                <input id="new-task-date" type="date" class="px-4 py-2 border rounded-xl outline-none" value="${new Date().toISOString().split('T')[0]}">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700"><i data-lucide="plus"></i> Add</button>
                            </div>
                        </form>
                        <div class="divide-y divide-slate-50">
                            ${tasks.length === 0 ? '<div class="p-10 text-center text-slate-400">No tasks found.</div>' : tasks.map(t => {
                                const isOverdue = !t.isCompleted && t.dueDate < Date.now();
                                return `
                                    <div class="p-5 flex items-center gap-5 group hover:bg-slate-50">
                                        <button onclick="toggleTask('${t.id}')" class="w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all ${t.isCompleted ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300'}">
                                            ${t.isCompleted ? '<i data-lucide="check" width="16"></i>' : ''}
                                        </button>
                                        <div class="flex-1">
                                            <p class="text-lg font-medium ${t.isCompleted ? 'line-through text-slate-400' : 'text-slate-800'}">${t.title}</p>
                                            <div class="flex items-center gap-3 mt-1 text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-slate-400'}">
                                                <i data-lucide="calendar" width="14"></i> ${new Date(t.dueDate).toLocaleDateString()}
                                                ${t.priority === 'high' && !t.isCompleted ? '<span class="bg-red-50 text-red-600 px-2 rounded text-[10px] uppercase border border-red-100">High</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function renderClients() {
            const clients = db.getClients();
            const html = `
                <div class="p-4 md:p-10 w-full max-w-[1800px] mx-auto pb-20">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold">Clients</h1>
                        <span class="bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-sm font-bold">${clients.length} Active</span>
                    </div>
                    <div class="grid md:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${clients.map(c => `
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-lg transition-all group">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-xl group-hover:text-blue-700 truncate">${c.name}</h3>
                                        <p class="text-sm text-slate-500 flex items-center gap-1.5 mt-1"><i data-lucide="briefcase" width="14"></i> ${c.serviceType}</p>
                                    </div>
                                    <div class="bg-blue-50 text-blue-600 p-2 rounded-xl"><i data-lucide="star" width="18"></i></div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-slate-50 text-sm text-slate-600">
                                    Renewal: <strong>${new Date(c.renewalDate).toLocaleDateString()}</strong>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${clients.length === 0 ? '<div class="text-center py-20 text-slate-400 border-2 border-dashed rounded-3xl mt-4">No clients yet. Win some leads!</div>' : ''}
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        // --- 5. CONTROLLERS & EVENT HANDLERS ---
        
        // Routing
        function handleRoute() {
            renderNav();
            const hash = location.hash || '#dashboard';
            if (hash === '#leads') renderLeads();
            else if (hash === '#tasks') renderTasks();
            else if (hash === '#clients') renderClients();
            else renderDashboard();
            lucide.createIcons();
        }
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        // Modals
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            document.body.style.overflow = '';
            
            // Stop speech if agent modal is closed
            if (id === 'agent-modal') {
                window.speechSynthesis.cancel();
            }

            // Reset Add Modal state if closed
            if(id === 'add-modal') {
                pendingImportData = [];
                document.getElementById('import-preview').classList.add('hidden');
                document.getElementById('excel-upload').value = '';
                // Optional: reset to manual tab or leave as is
            }
        }

        function openAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
        }
        
        // --- ADD LEAD LOGIC (Manual + Import) ---
        
        document.getElementById('add-lead-form').onsubmit = function(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            db.addLead({
                id: crypto.randomUUID(),
                name: fd.get('name'),
                phone: fd.get('phone'),
                email: fd.get('email'),
                company: fd.get('company'),
                status: LeadStatus.NEW,
                createdAt: Date.now()
            });
            e.target.reset();
            closeModal('add-modal');
            renderLeads(); // Refresh
        };

        // Tab Switching
        function switchTab(tab) {
            const manualBtn = document.getElementById('tab-manual');
            const importBtn = document.getElementById('tab-import');
            const manualForm = document.getElementById('add-lead-form');
            const importForm = document.getElementById('import-form');

            if(tab === 'manual') {
                manualForm.classList.remove('hidden');
                importForm.classList.add('hidden');
                manualBtn.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors";
                importBtn.className = "flex-1 py-4 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-colors";
            } else {
                manualForm.classList.add('hidden');
                importForm.classList.remove('hidden');
                importForm.classList.remove('animate-fade-in'); // Reset animation to trigger again if needed, or just let it show
                void importForm.offsetWidth; // Trigger reflow
                importForm.classList.add('animate-fade-in');
                
                manualBtn.className = "flex-1 py-4 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-colors";
                importBtn.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors";
            }
        }

        // Excel Import Logic
        let pendingImportData = [];

        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                
                pendingImportData = json;
                
                // Update UI
                const count = json.length;
                document.getElementById('import-count').innerText = count;
                document.getElementById('import-preview').classList.remove('hidden');
                
                // Visual feedback
                if(count > 0) lucide.createIcons();
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmImport() {
            if(!pendingImportData.length) return;
            
            let count = 0;
            pendingImportData.forEach(row => {
                // Mapping strategy based on User Request Image:
                // "Business Name", "Mobile Number", "Address", "Google Maps", "Rating"
                // Fallbacks included for generic CSVs
                
                const businessName = row['Business Name'] || row['BusinessName'] || row['Name'] || 'Unknown Lead';
                const phone = row['Mobile Number'] || row['Mobile'] || row['Phone'] || row['Number'] || '';
                
                // Extra data for notes
                const address = row['Address'] || '';
                const maps = row['Google Maps'] || row['Maps'] || '';
                const rating = row['Rating'] || '';
                
                const id = crypto.randomUUID();

                // Add Lead
                db.addLead({
                    id: id,
                    name: businessName, // Use Business Name as the main name
                    company: businessName, // Also use it as company
                    phone: String(phone),
                    email: '', // Not present in screenshot
                    status: LeadStatus.NEW,
                    createdAt: Date.now()
                });

                // Add Note with details
                if (address || maps || rating) {
                    const noteParts = [];
                    if(address) noteParts.push(` Address: ${address}`);
                    if(rating) noteParts.push(` Rating: ${rating}`);
                    if(maps) noteParts.push(` Map: ${maps}`);
                    
                    if(noteParts.length > 0) {
                        db.addInteraction({
                            id: crypto.randomUUID(),
                            leadId: id,
                            type: InteractionType.NOTE,
                            content: "Imported Data:\n" + noteParts.join('\n'),
                            timestamp: Date.now()
                        });
                    }
                }
                count++;
            });

            alert(`Successfully imported ${count} leads!`);
            
            // Clean up
            pendingImportData = [];
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('excel-upload').value = '';
            
            closeModal('add-modal');
            renderLeads();
            
            // Switch back to manual tab for next time
            setTimeout(() => switchTab('manual'), 300);
        }

        // Lead Details Modal Logic
        let currentLeadId = null;

        function openLeadModal(id) {
            currentLeadId = id;
            const lead = db.getLeads().find(l => l.id === id);
            if (!lead) return;

            const modal = document.getElementById('lead-modal');
            const content = document.getElementById('lead-modal-content');
            
            // Render basic info first
            renderLeadModalContent(lead);
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function renderLeadModalContent(lead) {
            const interactions = db.getInteractions().filter(i => i.leadId === lead.id).sort((a,b) => b.timestamp - a.timestamp);
            const rawPhone = lead.phone.replace(/\D/g, '');
            const waPhone = rawPhone.length === 10 ? '91' + rawPhone : rawPhone;

            const html = `
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 flex flex-col items-center text-center relative mb-6">
                    <div class="w-20 h-20 bg-white border-4 border-slate-50 text-blue-600 rounded-full flex items-center justify-center text-3xl font-bold mb-3 shadow-md">${lead.name[0]}</div>
                    <h3 class="text-2xl font-bold text-slate-900">${lead.name}</h3>
                    <p class="text-slate-500 text-sm mb-5">${lead.company || ''}</p>
                    <div class="flex gap-3 w-full justify-center">
                        <a href="tel:${lead.phone}" onclick="logAction('${lead.id}', 'Call')" class="flex-1 py-2 rounded-lg bg-green-50 text-green-700 flex justify-center gap-2 items-center font-medium active:scale-95 transition-transform"><i data-lucide="phone" width="18"></i> Call</a>
                        <a href="https://wa.me/${waPhone}" target="_blank" onclick="logAction('${lead.id}', 'WhatsApp')" class="flex-1 py-2 rounded-lg bg-emerald-50 text-emerald-700 flex justify-center gap-2 items-center font-medium active:scale-95 transition-transform"><i data-lucide="message-circle" width="18"></i> WA</a>
                        <a href="mailto:${lead.email}" onclick="logAction('${lead.id}', 'Email')" class="flex-1 py-2 rounded-lg bg-blue-50 text-blue-700 flex justify-center gap-2 items-center font-medium active:scale-95 transition-transform"><i data-lucide="mail" width="18"></i> Email</a>
                    </div>
                    <button onclick="deleteLead('${lead.id}')" class="absolute top-2 right-2 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><i data-lucide="trash-2" width="16"></i></button>
                </div>

                <div class="mb-6">
                    <label class="text-xs font-bold text-slate-500 mb-2 block uppercase">Add Note</label>
                    <div class="flex gap-2">
                        <input id="note-input" type="text" class="flex-1 bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:border-blue-400" placeholder="Type a note..." onkeydown="if(event.key === 'Enter') addNote()">
                        <button onclick="addNote()" class="bg-slate-800 text-white p-3 rounded-xl"><i data-lucide="save" width="20"></i></button>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-500 mb-4 uppercase">Recent Activity</h4>
                    <div class="space-y-6 relative before:absolute before:left-4 before:top-2 before:bottom-0 before:w-0.5 before:bg-slate-100 pb-4">
                        ${interactions.map(i => {
                            let icon = 'file-text', color = 'bg-slate-100 text-slate-600';
                            if(i.type === 'Call') { icon = 'phone'; color = 'bg-blue-100 text-blue-600'; }
                            if(i.type === 'WhatsApp') { icon = 'message-circle'; color = 'bg-emerald-100 text-emerald-600'; }
                            if(i.type === 'Email') { icon = 'mail'; color = 'bg-indigo-100 text-indigo-600'; }
                            
                            // Format content for links if needed (simple check)
                            let content = i.content;
                            if(content.includes('http')) {
                                content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 underline">Link</a>');
                            }
                            // Convert newlines to breaks for imported notes
                            content = content.replace(/\n/g, '<br/>');

                            return `
                                <div class="relative pl-12 animate-fade-in">
                                    <div class="absolute left-0 top-0 w-8 h-8 rounded-full ${color} flex items-center justify-center border-2 border-white shadow-sm z-10"><i data-lucide="${icon}" width="14"></i></div>
                                    <div class="bg-white rounded-xl p-3 border border-slate-100 shadow-sm">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-bold text-xs text-slate-700 uppercase">${i.type}</span>
                                            <span class="text-[10px] text-slate-400">${new Date(i.timestamp).toLocaleDateString()} ${new Date(i.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                                        </div>
                                        <p class="text-slate-600 text-sm leading-relaxed">${content}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.getElementById('lead-modal-content').innerHTML = html;
            lucide.createIcons();
        }

        // Actions
        function logAction(leadId, type) {
            // Immediate update - No timeouts
            db.addInteraction({
                id: crypto.randomUUID(), leadId, type, 
                content: `Initiated ${type} via app button`, timestamp: Date.now()
            });
            
            // Only refresh modal if we are NOT leaving the app (e.g. Note)
            // For Call/WA/Email, we let the browser handle the link and update data silently
            if (currentLeadId === leadId && type === InteractionType.NOTE) {
                 const lead = db.getLeads().find(l => l.id === leadId);
                 renderLeadModalContent(lead);
            }
        }

        function addNote() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if(!text || !currentLeadId) return;
            
            logAction(currentLeadId, InteractionType.NOTE); // This will trigger refresh
            
            // Manually update note content since logAction handles generic logic
            db.addInteraction({
                id: crypto.randomUUID(), leadId: currentLeadId, type: InteractionType.NOTE, 
                content: text, timestamp: Date.now()
            });
            const lead = db.getLeads().find(l => l.id === currentLeadId);
            renderLeadModalContent(lead);
        }

        function deleteLead(id) {
            if(confirm('Delete this lead?')) {
                db.deleteLead(id);
                closeModal('lead-modal');
                handleRoute(); // Refresh current page (Dashboard or Leads)
            }
        }

        function addTask(e) {
            e.preventDefault();
            const title = document.getElementById('new-task-title').value;
            const dateVal = document.getElementById('new-task-date').value;
            if(!title) return;
            
            db.saveTasks([...db.getTasks(), {
                id: crypto.randomUUID(), title, dueDate: new Date(dateVal).getTime(), isCompleted: false, priority: 'medium'
            }]);
            renderTasks();
        }

        function toggleTask(id) {
            const tasks = db.getTasks();
            const t = tasks.find(x => x.id === id);
            if(t) { t.isCompleted = !t.isCompleted; db.saveTasks(tasks); handleRoute(); }
        }

        // --- 6. OFFLINE AGENT 'JERRY' (NO AI) ---

        // Main Menu Queries
        const MainQueries = [
            { id: 'daily_summary', label: 'Daily Summary' },
            { id: 'leads_new', label: 'Show New Leads' },
            { id: 'leads_interested', label: 'Show Interested Leads' },
            { id: 'overdue_tasks', label: 'Show Overdue Tasks' },
            { id: 'renewals_soon', label: 'Renewals (30 Days)' },
            { id: 'conversion_rate', label: 'My Conversion Rate' }
        ];

        // Suggestion Logic Map
        const Suggestions = {
            'daily_summary': ['leads_new', 'overdue_tasks', 'calls_today'],
            'leads_new': ['leads_interested', 'daily_summary'],
            'leads_interested': ['won_deals', 'leads_new', 'calls_today'],
            'overdue_tasks': ['pending_tasks', 'daily_summary'],
            'renewals_soon': ['won_deals', 'conversion_rate'],
            'conversion_rate': ['won_deals', 'leads_interested', 'renewals_soon'],
            'won_deals': ['conversion_rate', 'renewals_soon'],
            'calls_today': ['leads_new', 'daily_summary']
        };

        // Complete Map of all possible queries for lookup
        const QueryRegistry = {
            'daily_summary': 'Daily Summary',
            'new_leads_today': 'New Leads Today',
            'pending_tasks': 'Pending Tasks',
            'calls_today': 'Calls Today',
            'won_deals': 'Won Deals',
            'leads_new': 'List New Leads',
            'leads_interested': 'List Interested Leads',
            'overdue_tasks': 'Overdue Tasks',
            'renewals_soon': 'Renewals Soon',
            'conversion_rate': 'Conversion Rate'
        };

        function openAgentModal() {
            document.getElementById('agent-modal').classList.remove('hidden');
            renderAgentOptions(MainQueries); // Show main menu initially
            
            // Initial greeting if chat is empty
            const chatArea = document.getElementById('agent-chat-area');
            if(chatArea.children.length === 0) {
                addAgentMessage("Hello! I am Jerry, your SoloCRM assistant. Select an option below to start.");
                speakText("Hello! I am Jerry. What would you like to know?");
            }
        }

        function resetAgentOptions() {
            renderAgentOptions(MainQueries);
        }

        function renderAgentOptions(options) {
            const container = document.getElementById('agent-options');
            container.innerHTML = options.map(q => `
                <button onclick="handleAgentQuery('${q.id}', '${q.label}')" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-full text-xs font-bold border border-slate-200 hover:bg-slate-200 active:scale-95 transition-all text-left animate-fade-in">
                    ${q.label}
                </button>
            `).join('');
        }

        function addAgentMessage(text, isUser = false) {
            const chatArea = document.getElementById('agent-chat-area');
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} chat-bubble mb-2`;
            
            div.innerHTML = `
                <div class="max-w-[85%] px-4 py-3 rounded-2xl text-sm leading-relaxed ${isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-slate-700 border border-gray-100 rounded-bl-none shadow-sm'}">
                    ${text.replace(/\n/g, '<br/>')}
                </div>
            `;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function speakText(text) {
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function handleAgentQuery(queryId, queryLabel) {
            // 1. User Message
            addAgentMessage(queryLabel, true);

            // 2. Logic Processing
            const leads = db.getLeads();
            const tasks = db.getTasks();
            const interactions = db.getInteractions();
            
            // Helper: Is Today?
            const isToday = (timestamp) => {
                const d = new Date(timestamp);
                const today = new Date();
                return d.getDate() === today.getDate() &&
                       d.getMonth() === today.getMonth() &&
                       d.getFullYear() === today.getFullYear();
            };

            let responseText = "";
            let speechText = "";

            // --- FILTER LOGIC ---
            if (queryId === 'daily_summary') {
                const newLeads = leads.filter(l => isToday(l.createdAt)).length;
                const calls = interactions.filter(i => i.type === InteractionType.CALL && isToday(i.timestamp)).length;
                const pending = tasks.filter(t => !t.isCompleted).length;
                
                responseText = `Here is your summary for today:\n New Leads: ${newLeads}\n Calls Made: ${calls}\n Pending Tasks: ${pending}`;
                speechText = `Here is your summary for today. You have ${newLeads} new leads, you made ${calls} calls, and you have ${pending} pending tasks.`;
            } 
            else if (queryId === 'leads_new') {
                const newLeads = leads.filter(l => l.status === LeadStatus.NEW);
                if (newLeads.length === 0) {
                    responseText = "You have 0 New leads.";
                    speechText = "You have no new leads.";
                } else {
                    const names = newLeads.slice(0, 5).map(l => l.name).join(', ');
                    responseText = `You have ${newLeads.length} 'New' leads.\nRecent: ${names}${newLeads.length > 5 ? '...' : ''}`;
                    speechText = `You have ${newLeads.length} new leads.`;
                }
            }
            else if (queryId === 'leads_interested') {
                const interested = leads.filter(l => l.status === LeadStatus.INTERESTED);
                if (interested.length === 0) {
                    responseText = "No leads marked as 'Interested' right now.";
                    speechText = "No interested leads found.";
                } else {
                    const names = interested.slice(0, 5).map(l => l.name).join(', ');
                    responseText = `Found ${interested.length} Interested leads:\n${names}`;
                    speechText = `Found ${interested.length} interested leads.`;
                }
            }
            else if (queryId === 'overdue_tasks') {
                const overdue = tasks.filter(t => !t.isCompleted && t.dueDate < Date.now());
                if (overdue.length === 0) {
                    responseText = "No overdue tasks. Excellent!";
                    speechText = "No overdue tasks. Excellent!";
                } else {
                    const titles = overdue.slice(0, 3).map(t => " " + t.title).join('\n');
                    responseText = `You have ${overdue.length} overdue tasks:\n${titles}`;
                    speechText = `You have ${overdue.length} overdue tasks.`;
                }
            }
            else if (queryId === 'renewals_soon') {
                const clients = db.getClients();
                const now = Date.now();
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const renewing = clients.filter(c => c.renewalDate > now && c.renewalDate < now + thirtyDays);
                
                if (renewing.length === 0) {
                    responseText = "No clients renewing in the next 30 days.";
                    speechText = "No upcoming renewals.";
                } else {
                    const names = renewing.map(c => c.name).join(', ');
                    responseText = `Clients renewing soon (${renewing.length}):\n${names}`;
                    speechText = `You have ${renewing.length} clients renewing soon.`;
                }
            }
            else if (queryId === 'conversion_rate') {
                const total = leads.length;
                const won = leads.filter(l => l.status === LeadStatus.WON).length;
                const rate = total > 0 ? ((won / total) * 100).toFixed(1) : 0;
                
                responseText = `Total Leads: ${total}\nWon Deals: ${won}\nConversion Rate: ${rate}%`;
                speechText = `Your conversion rate is ${rate} percent.`;
            }
            // ... Fallback for legacy ID compatibility if needed ...
            else if (queryId === 'calls_today') {
                const calls = interactions.filter(i => i.type === InteractionType.CALL && isToday(i.timestamp));
                responseText = `You have made ${calls.length} calls today.`;
                speechText = `You have made ${calls.length} calls today.`;
            }
            else if (queryId === 'won_deals') {
                const won = leads.filter(l => l.status === LeadStatus.WON);
                responseText = `Total Won Deals: ${won.length}`;
                speechText = `You have ${won.length} won deals.`;
            }
            else if (queryId === 'pending_tasks') {
                 const pending = tasks.filter(t => !t.isCompleted);
                 responseText = `You have ${pending.length} pending tasks in total.`;
                 speechText = `You have ${pending.length} pending tasks.`;
            }
            else {
                responseText = "I'm checking on that...";
                speechText = "Checking.";
            }

            // 3. Agent Response (Delayed slightly for effect)
            setTimeout(() => {
                addAgentMessage(responseText);
                speakText(speechText);
                
                // 4. Update Chips with Suggestions
                const nextIds = Suggestions[queryId];
                if (nextIds && nextIds.length > 0) {
                    const nextOptions = nextIds.map(id => ({ 
                        id: id, 
                        label: QueryRegistry[id] || id.replace('_', ' ').toUpperCase() 
                    }));
                    renderAgentOptions(nextOptions);
                } else {
                    // Fallback to main menu if no suggestions
                    resetAgentOptions();
                }

            }, 500);
        }

    </script>
</body>
</html>
